# 区块链技术细节（整理）

## 区块链分层参考模型

<img src="./images/blockchain_layer.jpg" style="zoom: 90%">

### 1. 网络层

区块链技术网络层本质上是一个P2P网络。以比特币为例，网络层涉及技术主要包括有构建网络、传播机制、同步机制、验证机制以及其他一些高级功能。

#### 1.1 构建网络

区块链网络层一般也是基于TCP/IP的，比特币网络使用的是8333端口，节点加入也是建立对应TCP链接。首先需要先找到一些稳定可靠的合法节点地址，
将自己版本内容等基本信息发送给网络上的节点，网络上的节点收到后，会检测是否兼容，之后回复确认信息建立连接。

#### 1.2 传播机制

网络层的功能主要是节点之间传播各类信息。一般是指向网络中主动发送信息，并依次转发在全网广播开来。这种信息一般主要是用户钱包新生成的交易信息，以及
矿工成功打包的区块信息。

#### 1.3 同步机制

指的是节点向邻居节点请求信息，用于同步各种数据。在比特币系统中，节点加入网络后，会向自己的邻居节点发送getaddr信息，请求自己的邻居节点将其维护的
节点地址列表同步给自己；除此之外，还会发送getblocks、getdata等请求来同步区块信息。

#### 1.4 验证机制

节点收到交易和区块信息后，对其合法性进行验证，只有合法正确的信息才会对其进行转发，如果不符合共识规则则丢弃。这样能保证全网中只传播合法信息，不至于
网络拥塞，同时防止DOS攻击。

#### 1.5 其他

在区块链技术发展过程中，不断加入了一些新功能和协议。例如，后来的比特币区块链中使用洋葱网络（Tor），原理是将用户发起的交易信息，先在网络中找到一些
节点转发，最后回到该用户自己，形成闭环，然后再从这个闭环内发送到全网，使得无法推断到底是哪个节点发起的这笔交易。

### 2. 数据层

区块链数据层就是嵌入式数据存储的一个分布式账本。除了账本外，节点一般会维护一些节点信息等元数据，属于区块链底层数据结构。目前包含的区块链数据层包含以下特征：

- 分布式账本：每个节点保存一份**完整**账本数据，存储于嵌入式数据库中；
- 区块结构：交易信息被打包成区块；
- 链式结构：所有区块通过哈希指针方式连接在一起，防止篡改；
- 节点信息：向邻居节点请求其维护的节点地址列表，这些返回值也会以文件形式存储在本地。

### 3. 安全层

主要是密码学中的技术，这层是区块链的安全保障。一般区块链中都涉及大量数字资产，所以区块链安全是现阶段比较重要，研究最广泛，成果最多的一个方向。
安全层提供的服务包括：

- 基础安全保证：在区块链的账户体系中，使用了椭圆曲线算法生成地址作为账户公开地址。另外，挖矿、地址生成、签名等多处使用了哈希算法。地址生成也用到了编解码算法；
- 隐私保护：比特币采用的是假名机制，由于账本是公开透明的，区块链不具备很好的隐私保护能力。目前区块链隐私保护的研究多集中在数字货币上，主要目标是将用户身份和交易
  以及交易金额做分离。现阶段可以被用于区块链隐私保护的技术主要有环签名技术、盲签名技术、零知识证明、同态加密以及新兴的安全多方计算。
- 网络安全：由于区块链网络的开放性，在设计区块链架构时，要重点考虑防止安全攻击的问题。常见攻击手段有：
    - DOS攻击：攻击者发送大量垃圾信息到某个节点或全网中，导致网络拥塞，造成DOS攻击；
    - 女巫攻击：攻击者搭建大量恶意节点，以此获得大量投票数；
    - 日蚀攻击：比特币单节点一般默认设置8个连接，攻击者可以设置8个恶意节点去连接至某个正常节点，导致其被隔离出比特币网络，这通常是针对交易所的攻击。
- 密钥安全：区块链之上的数字资产的拥有权完全绑定到单一秘钥，一旦丢失就无法找回。所以这是设计数字钱包时，需要重点考虑的问题。目前市场上的钱包一般分为
  硬件钱包、在线钱包等，它们在可用性和安全性方面有不同的考量。密钥安全涉及的技术，主要有分层确定性密钥管理、助记词、离线签名等。
- 算法安全：区块链设计过程中，也需要考虑所使用算法的安全性，必须使用那些目前被证明为极难被破解的算法。目前的区块链项目中多采用椭圆曲线算法、SHA-256等。

### 4. 共识层

这层的作用是让所有人按照一种机制对区块链的某一刻的状态达成一致性的认识，本质上是一个分布式系统中的一致性方案，用于解决拜占庭将军问题。区块链系统中
需要达成共识的内容主要包括三部分：交易、区块、以及一些其他共识内容。  
关于共识机制的研究成果已经有多种方案，如Paxos、Raft等；目前现有区块链项目中所采用的共识算法如下表所示：

| 项目                                              | 共识机制                           |
|-------------------------------------------------|--------------------------------|
| 比特币系列：以Bitcoin技术体系为基础发行<br/>的数字货币，如莱特币、达低币、大零币等 | PoW                            |
| 点点币                                             | PoS                            |
| 以太坊                                             | PoW结合PoS，未来会升级到纯PoS共识          |
| 超级账本                                            | Kafka算法，Solo排序；共识机制可插拔，支持拜占庭容错 |
| 比特股、Steem、EOS等                                  | DPoS                           |
| 瑞波                                              | 瑞波共识（Ripple）                   |

### 5. 合约层

主要包括各种脚本、代码、算法机制和智能合约，它是区块链技术可编程的基础保证。合约层的本质是将代码逻辑存储在区块链中，实现可以自行定义和编写的智能合约，
在触发某一条件时，无需第三方调用，代码自动执行，即常说的「代码即法律」，这也是区块链去信任的基础。  
智能合约一般使用高级语言编写后，编译成为可供区块链用户调用的ABI二进制接口文件，部署到区块链上。目前公有链的智能合约编程分为两类：

- 以太坊：使用的是Solidity语言，执行环境是EVM虚拟机；
- EOS：它选用的语言是功能更强大的C++，执行环境是WebAssembly。并且EOS考虑了可扩展性设计，将会支持安全的沙盒环境设计成可插拔模式，将来可支持各种
  沙盒，以允许其他平台的智能合约无缝迁移到此平台。

### 6.服务层

主要包括区块链中的数字货币发行机制和分配机制。比特币中引入挖矿奖励来激励节点加入去完成区块打包和验证工作；达氏币中加入网络成为混币节点需要抵押一部分
数字货币，如果作恶则不会返回；EOS为代表的基于DPoS共识建立的区块链系统中，为防止女巫攻击，使用代币作为抵押投票。在早期区块链体系中，被成为激励层。

### 7.应用层

主要包括各类场景下的实际应用，类似常用的PC客户端、手机客户端等。二者区别是，区块链中的应用叫做去中心化应用（DApp）。由于早期区块链主要应用场景就是
数字货币，所以当时主要应用层就是各类数字货币钱包。  
目前，受限于行业生产关系变革中遇到的阻力，区块链应用暂时还没有彻底普及开来。典型的应用，如以太坊上运行最多的就是众筹项目，EOS上运行最多的应用集中
在博彩业。

## 区块链现存问题

### 1. 数据冗余过量

在一个完全去中心化的区块链系统中，用户如果想要亲自验证交易合法性，同时保证数据的可信、完整、未篡改的特性，用户就需要下载全部的账本。
随着时间的推移，区块链的数据量呈线性递增，长期以往，极大提高了用户的使用成本，导致用户只能依赖其他全节点去验证交易，然而这会导致新的中心化趋势。

以比特币为例，每10min产生一个区块，每个区块1MB，每年的区块增长速度为24x60/10x365=51.3GB，10年后大概需要5TB。EOS理论上可以达到太字节（百万TB），
按照一个交易100字节计算，1天的区块数据为1000000x100x60x60x24=7.8TB，一年的区块数据量为7.8x265=2868TB，到2023年大约需要14340TB存储空间。
另外，还需要包括智能合约代码以及用户上传的图片、视频等。普通用户个人用户显然无法承担如此巨大的存储空间。

### 2. 系统安全

区块链本质上是一个分布式数据库。与传统应用系统不同，在运行过程中，区块链会将数据信息采用分布式方式记录，并且通过共识机制由所有参与者共同记录。
整个区块链平台具有开放性的特点，特别是公有链中，任意节点可以自由加入/退出区块链网络，任意节点都可以存储整个账本数据。区块链的这种开放性也决定了其不同于传统技术的安全问题。

### 3. 共识算法

就目前业界研究情况来看，并不存在一种完美的共识算法适用于任何场景，每一种共识算法均有自己的优缺点，适用于不同的应用场景，我们只能根据实际应用来取舍。
例如，在最早的区块链平台中，比特币和以太坊都采用PoW算法。PoW算法是目前唯一经过严格数学论证的安全共识机制，但其缺点也是明显，那就是速度慢且严重浪费资源。
BitShare和EOS等所采用的DPoS共识机制虽然提高了效率，并解决了资源浪费的问题，但是牺牲了去中心化的特性，存在21个超级节点，并且共识的安全严重依赖于代币。

由于目前设计完美的共识机制几乎不太可能实现，所以大多数项目在开发区块链平台时，均会考虑可插拔共识机制，用户在实际部署应用时，可以根据场景使用合适的共识机制。

下表展示了常见共识机制之间的特点对比：

| 共识机制     | 是否挖矿 | 需要代币 | 安全性 | 资源消耗 | 去中心化程度 | 交易确认时间 | 交易性能 | 典型项目          | 适用场景   |
|----------|------|------|-----|------|--------|--------|------|---------------|--------|
| ByteBall | 否    | 是    | 高   | 小    | 不完全    | 长      | 高    | ByteBall      | DAG区块链 |
| IOTA     | 否    | 是    | 高   | 小    | 完全     | 长      | 高    | IOTA          | DAG区块链 |
| Pool验证池  | 否    | 否    | 高   | 小    | 不完全    | 实时     | 高    | 私有链           | 私有链    |
| Ripple   | 否    | 是    | 高   | 小    | 不完全    | 实时     | 高    | Ripple网       | 公有链    |
| Paxos    | 否    | 否    | 高   | 小    | 不完全    | 实时     | 高    | 暂无            | 联盟链    |
| PBFT     | 否    | 否    | 高   | 小    | 不完全    | 实时     | 高    | 超级账本          | 联盟链    |
| DPoS     | 否    | 是    | 高   | 小    | 不完全    | 秒级     | 高    | BitShare、EOS等 | 公有链    |
| PoS      | 是    | 是    | 高   | 一般   | 完全     | 短      | 低    | 点点币、未来币等      | 公有链    |
| PoW      | 是    | 是    | 高   | 大    | 完全     | 长      | 低    | 比特币、莱特币等      | 公有链    |

### 4. 可扩展性

区块链的可扩展性问题主要包括两个方面：交易效率和区块链的分叉与升级。

#### 4.1 交易性能

我们已经知道，比特币区块链每秒只能处理大概7笔交易，每笔交易需要接近1h的确认时间。相较于比特币，以太坊的处理速度得到了不小的改善，每秒可以处理二十多笔交易，
每笔交易一般推荐15-20个区块的确认，大约时间为4-8分钟。而现有的传统系统中，像支付宝交易的处理峰值可达每秒几十万，如果投入正式环境，区块链现有的处理速度实在难以让人满意。

可扩展性是传统分布式系统的基本特性，但区块链由于去中心化的要求，难以满足可扩展性。业界总结了一个三元悖论描述去中心化与可扩展性之间的矛盾，
尚未被严格证明，只能被称为猜想，但实际系统设计过程中却能感觉到时时受其挑战：去中心化、安全性、可扩展性这三个属性，区块链系统无法同时满足，最多三选二。
这也叫做分布式不可能三角。

就目前来说，解决区块链交易性能的主要方案有以下几种：  
**【共识机制创新】**  
从PoW到PoS再到DPoS和各种BFT类算法，共识机制不断创新，区块链平台性能也不断得到提升。**但需要明确的是**，后来创新的这些共识机制，
并非各方面都优于开始PoW，而是在其他方面作出了妥协，以达到提高交易性能的目的。比如PoS虽然解决了资源浪费问题，但是却产生了高概率分叉以及弱去中心化问题；
而DPoS虽然性能高，但是该算法以代理人共识取代全网共识的做法也受到一部分人的抨击。

**【交易通道】**  
交易通道的思路是保持底层区块链协议不变，将交易放到链下进行，通过改变协议用法的方式来解决扩展性问题。链下部分可以采用传统中心化分布式系统实现，
闪电网络是典型方案的一种。

**【分片处理】**  
以太坊项目正在研发中的分片（sharding）方案的总体思路是每个节点只处理一部分交易，比如一部分账户发起的交易，从而减轻节点的计算和存储负担。

**【多链架构】**  
主要思路是将原本的一条链分成多条链，每条链都负责部分计算和存储业务，并且有可扩展性，即链的数量可以随着业务量和数据的增加而增加，系统的总体性能和存储空间也会随之提升。
**侧链**技术就是一种方案。

#### 4.2 链的分叉（fork）

区块链的分叉，尤其是硬分叉也是一个目前难以解决的问题。最典型的例子，就是The
DAO事件所造成的以太坊分叉为ETH和ETC两条链，虽然为用户挽回了智能合约安全问题造成的损失，
但是导致了很大一部分人对区块链去中心化的质疑，显然这是靠中心化的运作强行更改了系统的运行轨迹。再比如BTC与BCH的分叉、BCH与BSV的分叉，也都造成了社区的分裂，
这不仅是技术层面的分歧，更多的也是各方利益使然。

**【硬分叉】**  
硬分叉是指代码修改后，旧节点拒绝接收新节点创造的区块。不符合原规则的区块将被忽略。硬分叉将会导致一个正在运行的区块链系统在某个区块高度发生永久分叉，
分叉点后产生的区块互不关联。硬分叉是**不向前兼容**的。

**【软分叉】**  
软分叉是指旧节点不会意识到系统代码发生改变，并继续接收新节点创造的区块，所以软分叉是**向前兼容**的。

分叉通常是为了解决当前系统中的某些问题，比如提高交易性能，亦或回滚某些交易（The DAO事件）。比特币采用的隔离见证就是一种软分叉方案，
隔离见证的思路是在不改变区块结构及参数的前提下，将签名信息放在块外存储，从而间接对区块扩容，提高了一些交易效率。而BCH则认为隔离见证只是减缓了网络拥塞问题，
也没有显著提高交易效率，还使得系统结构变得复杂，不利于未来系统改造。所以比特币社区又产生出另一种方案，那就是直接修改区块参数，将区块大小1MB的限制改为4MB。
显然，这种修改不是向前兼容的，旧节点不会认可4MB的区块，从而导致BTC分叉出了BCH。

## 区块链安全问题

相对于传统单点中心化服务的模式，区块链去中心化的特性在安全层面上已经是一种非常大的进步。在传统信息安全领域中，安全包括三个基本要素，
分别是保密性、完整性、可用性。本节从这三个方面入手，分析区块链自身所带的安全特性。

### 1. 区块链安全属性

#### 1.1 保密性

保密性是指要求保护数据内容不被泄露给非授权的个人、实体或流程，强调有用信息只被授权对象使用的特征。常用保密手段如下：

- 物理保密：利用限制、隔离、掩蔽、控制等措施，保护信息不被泄露；
- 防窃听：使对手侦听不对有用信息；
- 防辐射：防止有用信息以各种途径辐射出去；
- 信息加密：在密钥的控制下，用加密算法对信息加密存储、传播。即使对手得到了加密后的信息，也会因为没有密钥无法读取内容。

在区块链技术中，列举下面几种使用加密技术的场景：

- 存储用户密钥场景中使用了加密技术（用户设置一个密码来保存私钥在本地）
- 交易场景中使用了非对称加密技术来实现了无泄密授权（对交易签名）；
- 门罗币使用环签名算法来实现隐匿交易双方地址。

#### 1.2 完整性

完整性是指用户、进程或者硬件组件具有验证所发送或传送的内容的准确性的能力，并且进程或硬件组件不会被任何方式改变。完整性的目的是通过阻止威胁或探测威胁，保护可能遭到不同方式危害数据的完整性和数据相关属性的完整性。

区块链对数据的完整性实现了很好的保护。其主要通过链式账本、哈希加密以及交易签名技术保护了整个账本数据的完整性。

#### 1.3 可用性

可用性通常是指在某个考察期内系统正常运行的效率。可用性受到系统错误、基础设施问题、恶意攻击和系统负载等因素影响，通常以正常运行时间的百分比来衡量。
同时，如何在合理的时间内响应用户的请求也是可用性的一个重要方面。

在区块链系统中，由于多个节点的存在、多个备份的账本，从正常运行时间百分比的角度来看，可用性是增强的。以比特币为例，从2009年1月比特币网络正式启动至今，
已经有十多年的光阴，这期间只出现了有限次的安全事件，几乎一直处于稳定运行状态。但同样是由于这种分布式多备份的特性，数据同步和共识机制的存在，
使得区块链在性能方面与传统中心化系统相比还有很大差距。从这一角度讲，区块链在可用性方面，相较于保密性和完整性，还有很大的改进空间。

### 2. 数据层安全

#### 2.1 数据存储安全

在传统信息安全中，数据存储安全的目标包含多个方面，如保护机密数据、确保数据完整性、防止数据破坏和丢失等。而这些工作都是由提供服务的中心化机构来完成。
对于区块链技术来说，其账本具有分布式存储且不可篡改的特性，所以区块链上的数据天然具有存储安全的特性，而保护机密数据则需要区块链隐私保护技术来实现，
这一点在后续章节进行说明。

在传统信息安全中，实现数据安全的方式有很多种，如访问控制、增加安全硬件防护等。而区块链是一种开放、去中心化的技术，数据安全完全依赖于密码学技术，
例如比特币中交易和区块实体都涉及非对称加密算法、数字签名和哈希技术等多种密码学组件。为满足更高的隐私保护需求，还要引入环签名、零知识证明、
多方安全计算等隐私保护技术。区块链本身开放式的技术特点也决定了其数据安全会面临与传统信息安全不同的风险。

综上所述，区块链数据层的安全主要包括两个方面，密码学算法本身的安全风险和区块链数据内容的安全风险。

**【一、密码算法安全风险】**  
信息安全理论中，密码算法安全分为信息论安全和计算安全。信息论安全是指无条件安全、绝对安全，但为了考虑实用性，我们所使用的密码均为计算安全，
即基于一个困难的数学假设，在现有计算能力下是解不开这个数学难题的。例如，现在区块链技术中常用到的椭圆曲线算法，就是基于离散对数问题，这种算法目前来看是安全的。
但是，从现代密码学发展历史来看，MD5/DES等早期常用算法均被证明了存在安全漏洞，以及SHA-1算法也在2005年2月被证明安全性不足，SHA-2和SHA-1类型，
虽然还未出现有效攻击，但安全性也被严重质疑。随着量子计算的飞速发展，现在被认为安全的算法，未来也未必是无懈可击。  
目前针对加密算法进行攻击的方式主要有穷举攻击、碰撞攻击、长度扩展攻击、后门攻击、量子攻击等。而量子计算对一般密码算法的影响如下表所示：

| 密码算法        | 类型   | 功能      | 安全性影响  |
|-------------|------|---------|--------|
| AES         | 对称密码 | 加密      | 攻击难度减半 |
| SHA-2,SHA-3 | 哈希算法 | 哈希      | 攻击难度减半 |
| RSA         | 公钥算法 | 加密      | 攻破     |
| ECDSA,ECDH  | 公钥算法 | 签名，密钥交换 | 攻破     |
| DSA         | 公钥算法 | 签名，密钥交换 | 攻破     |

**【二、链上内容安全风险】**  
由于区块链技术拥有不可篡改/删除的特性，给到了不法分子可利用之处。不法分子将大量有害信息、病毒特征码、淫秽信息等写入区块链中，影响区块链生态环境。
另一方面，大量垃圾交易数据攻击会阻塞区块链，使得正常交易和信息迟迟得不到处理。

#### 2.2 密钥存储安全
在目前的知名区块链应用中，不乏大量的加密货币应用，这其中涉及到数字资产交易，直接关系到用户利益，也成为攻击者的目标。即使现代密码学技术现阶段是安全的，
也是建立在密钥安全的基础上。然而现有区块链技术普遍缺乏有效的密钥管理技术。以比特币为例，每年因使用、存储不当导致的密钥丢失都会给用户带来巨大的利益损失。

目前，区块链技术中主流的密钥管理方法包括本地存储、离线存储、托管存储和门限钱包。

**【一、本地存储】**  
将密钥直接或加密存放在本地存储介质中，这种方法最不安全，很容易被恶意读取和使用，本地设备损坏时也无法恢复。

**【二、离线存储】**  
将密钥存储在不联网的离线设备中，完全与互联网隔离，如现在常见的硬件钱包，这种方案最大的问题是携带和使用不方便，而且有些离线存储方案在使用时仍需要接入互联网，
无法完全避免恶意软件的入侵。

**【三、托管存储】**  
可以使用第三方提供的托管服务管理密钥，但这显然违反了区块链去中心化的本意，密钥的安全与否完全取决于第三方机构的可信程度。

**【四、门限钱包】**  
使用门限加密技术将密钥分散处处在多个设备中，使用时需要多方参与，如常见的（t,n）门限密码算法，n个参与者中至少有t方参与才可恢复密钥，
允许最大t-1个被攻破。

### 3. 网络层安全
区块链中的网络节点，可能是云服务器，也可能是个人计算机，安全性必然参差不齐，对安全性较差的节点发起网络攻击，必然会造成严重的后果。
针对区块链分布式网络的安全风险，主要分为DDoS攻击、女巫攻击和日蚀攻击。

#### 3.1 DDoS攻击
由于目前区块链系统的处理能力有限，攻击者很容易向某个节点发送垃圾交易，通过较大流量致使该节点瘫痪。除此之外，攻击者也可以利用节点客户端的漏洞发起攻击，使其无法提供服务。
程度较轻的情况下，只攻击一个节点，使某个节点的用户无法使用区块链服务。程度严重的话，使网络中部分节点瘫痪，这就意味着全网的安全性直接降低，
例如在比特币网络，这意味着总体算力的下降，网络会更容易遭受51%攻击。而且，目前发起DDoS攻击的成本非常低，大量的攻击工具可以从黑市上轻易购买。

#### 3.2 女巫攻击
女巫攻击（Sybil Attack）是2002年提出的，它是作用于P2P网络中的一种攻击形式，攻击者利用单个节点来伪造多个身份存在于P2P网络中，从而达到削弱网络的冗余性，
降低网络健壮性，监视或干扰网络正常活动等目的。

目前，对抗女巫攻击的手段主要是防止身份伪造。由于公链和联盟链的网络结构不同，抗女巫攻击的方式一般也分为两种。

**【一、公有链】**  
主要做法是设计共识机制时，不依赖于节点数量。常用共识机制PoW采用算力证明节点身份不是伪造的（算力提高伪造成本），算力大的具有主导权；
PoS采用代币也就是股权证明节点的身份不是伪造的，股权大的具有主导权；DPoS采用代币投票，而不是一机一票。

**【二、联盟链】**  
联盟链主要采用的共识机制都是一机一票形式的，如PBFT。联盟链一般是引入身份认证的机制，具体分两种，基于第三方的身份认证和纯分布式的身份认证。
二者区别在于，前者需要一个可信机构管理身份认证，而纯分布式身份认证则需要全网大多数节点认证才可以加入网络。

#### 3.3 日蚀攻击
TODO

参考：

- [《区块链技术开发指南-马兆丰》](https://baike.baidu.com/item/区块链技术开发指南/56688853?fr=aladdin)
