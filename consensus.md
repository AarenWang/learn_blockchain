# 共识算法

共识算法是各类分布式系统（如分布式文件系统、分布式DB）中保证系统状态一致性的重要技术。根据需求不同，在不同场景使用的共识算法也不同，如公链和联盟链
对共识算法的要求不同，所使用的算法也不同。

公链要求共识算法具有高扩展性，能够在节点动态传入网络的情况下保证共识流程的节奏，同时又要防止拜占庭节点对网络的攻击。受限于FLP定理和CAP定理，公链使用的
共识算法一般不能保证强一致性；而联盟链则需要强一致性、高性能，但对高扩展性和防止拜占庭节点攻击方面的要求没有公链那么高。

## 背景

### 1. 早期数据库系统中的共识机制

#### 1.1 两阶段提交
在数据库系统中，两阶段提交是一个普遍使用的保证一致性的方法。它是由一个协调节点作为中央控制节点。

**第一阶段**  
协调节点向询问所有节点「是否准备好」，等待各节点响应

**第二阶段**  
若各节点响应都是OK，则协调节点向所有节点广播**Commit**指令，只要有一个说不就是**Rollback**指令。

**缺陷**  
当出现协调节点和其他某一节点故障时（或者说第二阶段其他节点超时未收到回复），会出现有的提交有的回滚的问题，称之为脑裂！

#### 1.2 三阶段提交
为了解决两阶段提交问题，三阶段提交出现了。与前者的不同之处在于，在正式提交前，协调节点会再发送一次「准备提交」的消息，当收到所有节点的OK回复后，
协调节点再广播**Commit**指令。  
它只解决了两阶段提交中协调节点和其他节点同时故障的问题，但是系统严重依赖一个协调节点，另外其余节点也没有办法形成对协调节点是否出现故障的共识。因此，
无论两阶段提交或三阶段提交，都不能作为一个分布式共识算法，只能在通常情况下保障分布式系统的一致性。

#### 1.3 小结
两阶段和三阶段提交一般用在同步通信的分布式系统中，而多数分布式系统是由多个主机通过异步通信的方式组成集群。 在异步系统中，可能出现无法通信的故障主机，
主机可能性能不够，网络可能拥塞，都会导致错误信息再系统内传播。因此，需要更健壮的共识算法在默认不可靠的异步网络中建立容错协议，以确保各主机达成安全
可靠的状态共识。

### 2. 拜占庭将军问题
这个问题是区块链平台共识机制需要解决的一个核心问题，学习共识算法需要先理解它。  

拜占庭将军问题，是美国计算机科学家莱斯利·兰波特在1980年提出的点对点通信网络中的容错问题。下面贴出他在论文中的描述(来自维基百科)：
>一组拜占庭将军分别各率领一支军队共同围困一座城市。为了简化问题，将各支军队的行动策略限定为**进攻或撤离**两种。因为部分军队进攻部分军队撤离可能会造成
> 灾难性后果，因此各位将军必须通过投票来达成一致策略，即所有军队一起进攻或所有军队一起撤离。因为各位将军分处城市不同方向，他们只能通过信使互相联系。
> 在投票过程中每位将军都将自己投票给进攻还是撤退的信息通过信使分别通知其他所有将军，这样一来每位将军根据自己的投票和其他所有将军送来的信息就可以知道
> 共同的投票结果而决定行动策略。

系统的问题在于，可能将军中出现叛徒，他们不仅可能向较为糟糕的策略投票，还可能选择性地发送投票信息。假设有9位将军投票，其中1名叛徒。8名忠诚的将军中
出现了4人投进攻，4人投撤离的情况。这时候叛徒可能故意给4名投进攻的将领送信表示投票进攻，而给4名投撤离的将领送信表示投撤离。这样一来在4名投进攻的
将领看来，投票结果是5人投进攻，从而发起进攻；而在4名投撤离的将军看来则是5人投撤离。这样各支军队的一致协同就遭到了破坏。如下图

<img src="./images/baizhanting_problem.jpg" style="zoom: 60%">

